<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TestIQ Analysis Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f7fa;
            padding: 20px;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 40px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .timestamp {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 30px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-card.success {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .stat-card.warning {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .stat-card.info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        h2 {
            color: #2c3e50;
            margin-top: 40px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background: white;
        }
        th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 400px;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-danger {
            background: #fee;
            color: #c33;
        }
        .badge-warning {
            background: #ffeaa7;
            color: #d63031;
        }
        .badge-info {
            background: #dfe6e9;
            color: #2d3436;
        }
        .test-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .test-name {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            background: #ecf0f1;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
            max-width: 100%;
            line-height: 1.6;
        }
        .test-name .test-part {
            display: inline;
        }
        .test-name .test-separator {
            color: #3498db;
            font-weight: bold;
            margin: 0 2px;
        }
        .action {
            color: #27ae60;
            font-weight: 600;
        }
        .footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
        }
        .clickable-row {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .clickable-row:hover {
            background: #e8f4f8 !important;
            transform: translateX(3px);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }
        .modal-content {
            background-color: white;
            margin: 10px auto;
            padding: 0;
            width: calc(100% - 20px);
            height: calc(100vh - 20px);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: transform 0.2s;
        }
        .close:hover {
            transform: scale(1.2);
        }
        .split-view {
            display: flex;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }
        .split-view.independent {
            overflow: hidden;
        }
        .file-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 2px solid #ecf0f1;
            min-width: 0;
        }
        .file-panel.independent {
            overflow-y: auto;
        }
        .file-panel:last-child {
            border-right: none;
        }
        .panel-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 2px solid #ecf0f1;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-shrink: 0;
        }
        .file-content {
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.8;
            background: #fafafa;
        }
        .code-line {
            padding: 2px 8px;
            border-radius: 3px;
            margin: 1px 0;
            white-space: pre;
        }
        .covered {
            background: #d4edda;
            border-left: 3px solid #28a745;
            font-weight: 600;
        }
        .not-covered {
            opacity: 0.6;
        }
        .file-path {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #7f8c8d;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .coverage-info {
            background: #e8f4f8;
            padding: 15px;
            margin: 10px 20px;
            border-left: 4px solid #667eea;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }
        .filter-section {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-select {
            padding: 6px 10px;
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 4px;
            font-size: 0.85em;
            background: rgba(255,255,255,0.95);
            cursor: pointer;
            min-width: 180px;
            color: #2c3e50;
        }
        .filter-select:hover {
            background: white;
            border-color: white;
        }
        .sync-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255,255,255,0.95);
            border: 1px solid rgba(255,255,255,0.5);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85em;
            color: #2c3e50;
        }
        .sync-toggle:hover {
            background: white;
            border-color: white;
            background: #f0f0ff;
        }
        .sync-toggle.active {
            background: #667eea;
            color: white;
        }
        .sync-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .progress-bar {
            height: 30px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ TestIQ Analysis Report</h1>
        <div class="timestamp">Generated on 2026-01-13 16:23:26</div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value">12</div>
                <div class="stat-label">Total Test Methods</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value">1</div>
                <div class="stat-label">Exact Duplicate Groups</div>
            </div>
            <div class="stat-card info">
                <div class="stat-value">3</div>
                <div class="stat-label">Similar Test Pairs</div>
            </div>
            <div class="stat-card warning">
                <div class="stat-value">10</div>
                <div class="stat-label">Subset Duplicates</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" style="width: 8.3%">
                8.3% Duplicates
            </div>
        </div>

        <h2>üéØ Exact Duplicates</h2>
        <p>Tests with identical code coverage that can be safely removed.</p>

        <table>
            <thead>
                <tr>
                    <th>Group</th>
                    <th>Tests</th>
                    <th>Count</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr class="clickable-row" onclick="showComparison(0)">
                    <td><strong>Group 1</strong></td>
                    <td><span class="test-name">test_user_login_basic</span><br><span class="test-name">test_user_login_with_password</span></td>
                    <td><span class="badge badge-danger">2 tests</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
            </tbody>
        </table>

        <h2>üîç Similar Tests (‚â•70% overlap)</h2>
        <p>Test pairs with significant code coverage overlap that may indicate redundancy.</p>

        <table>
            <thead>
                <tr>
                    <th>Test 1</th>
                    <th>Test 2</th>
                    <th>Similarity</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr class="clickable-row" onclick="showComparison(1)">
                    <td><span class="test-name">test_user_login_basic</span></td>
                    <td><span class="test-name">test_admin_login</span></td>
                    <td><span class="badge badge-info">76.9%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
                <tr class="clickable-row" onclick="showComparison(2)">
                    <td><span class="test-name">test_user_login_with_password</span></td>
                    <td><span class="test-name">test_admin_login</span></td>
                    <td><span class="badge badge-info">76.9%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
                <tr class="clickable-row" onclick="showComparison(3)">
                    <td><span class="test-name">test_logout_user</span></td>
                    <td><span class="test-name">test_logout_admin</span></td>
                    <td><span class="badge badge-info">70.0%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
            </tbody>
        </table>

        <h2>üìä Subset Duplicates</h2>
        <p>Tests that are subsets of other tests and may be redundant.</p>

        <table>
            <thead>
                <tr>
                    <th>Subset Test</th>
                    <th>Superset Test</th>
                    <th>Coverage Ratio</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <tr class="clickable-row" onclick="showComparison(4)">
                    <td><span class="test-name">test_user_login_basic</span></td>
                    <td><span class="test-name">test_admin_login</span></td>
                    <td><span class="badge badge-warning">76.9%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
                <tr class="clickable-row" onclick="showComparison(5)">
                    <td><span class="test-name">test_user_login_with_password</span></td>
                    <td><span class="test-name">test_admin_login</span></td>
                    <td><span class="badge badge-warning">76.9%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
                <tr class="clickable-row" onclick="showComparison(6)">
                    <td><span class="test-name">test_logout_user</span></td>
                    <td><span class="test-name">test_logout_admin</span></td>
                    <td><span class="badge badge-warning">70.0%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
                <tr class="clickable-row" onclick="showComparison(7)">
                    <td><span class="test-name">test_user_profile_view</span></td>
                    <td><span class="test-name">test_user_profile_edit</span></td>
                    <td><span class="badge badge-warning">61.5%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
                <tr class="clickable-row" onclick="showComparison(8)">
                    <td><span class="test-name">test_user_login_basic</span></td>
                    <td><span class="test-name">test_user_login_complete</span></td>
                    <td><span class="badge badge-warning">55.6%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
                <tr class="clickable-row" onclick="showComparison(9)">
                    <td><span class="test-name">test_user_login_with_password</span></td>
                    <td><span class="test-name">test_user_login_complete</span></td>
                    <td><span class="badge badge-warning">55.6%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
                <tr class="clickable-row" onclick="showComparison(10)">
                    <td><span class="test-name">test_user_login_minimal</span></td>
                    <td><span class="test-name">test_user_login_basic</span></td>
                    <td><span class="badge badge-warning">30.0%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
                <tr class="clickable-row" onclick="showComparison(11)">
                    <td><span class="test-name">test_user_login_minimal</span></td>
                    <td><span class="test-name">test_user_login_with_password</span></td>
                    <td><span class="badge badge-warning">30.0%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
                <tr class="clickable-row" onclick="showComparison(12)">
                    <td><span class="test-name">test_user_login_minimal</span></td>
                    <td><span class="test-name">test_admin_login</span></td>
                    <td><span class="badge badge-warning">23.1%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
                <tr class="clickable-row" onclick="showComparison(13)">
                    <td><span class="test-name">test_user_login_minimal</span></td>
                    <td><span class="test-name">test_user_login_complete</span></td>
                    <td><span class="badge badge-warning">16.7%</span></td>
                    <td><span style="color: #667eea; font-weight: 600;">üîç View Coverage</span></td>
                </tr>
            </tbody>
        </table>

        <!-- Modal for split-screen coverage view -->
        <div id="comparisonModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0;">üìä Coverage Comparison</h2>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="filter-section">
                            <label for="fileFilter" style="font-weight: 600; margin-right: 8px;">üìÅ</label>
                            <select id="fileFilter" class="filter-select" onchange="applyFileFilter()">
                                <option value="">All Files</option>
                            </select>
                        </div>
                        <div class="sync-toggle" id="syncToggle" onclick="toggleSync()">
                            <input type="checkbox" id="syncCheckbox" class="sync-checkbox" checked>
                            <label for="syncCheckbox" style="cursor: pointer; user-select: none;">üîó Sync Scroll</label>
                        </div>
                        <span class="close" onclick="closeModal()">&times;</span>
                    </div>
                </div>
                <div class="coverage-info">
                    <div>
                        <strong>Subset Test:</strong> <span id="subsetName" class="test-name"></span>
                        &nbsp;&nbsp;|&nbsp;&nbsp;
                        <strong>Superset Test:</strong> <span id="supersetName" class="test-name"></span>
                        &nbsp;&nbsp;|&nbsp;&nbsp;
                        <strong>Coverage Ratio:</strong> <span id="coverageRatio" class="badge badge-warning"></span>
                    </div>
                </div>
                <div class="split-view">
                    <div class="file-panel">
                        <div class="panel-header">üìÑ Subset Test Coverage</div>
                        <div id="subsetContent" class="file-content"></div>
                    </div>
                    <div class="file-panel">
                        <div class="panel-header">üìÑ Superset Test Coverage</div>
                        <div id="supersetContent" class="file-content"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
        const coverageData = [{"subset": {"auth/login.py": [10, 11, 12, 15, 20, 25], "models/user.py": [5, 6, 7, 8]}, "superset": {"auth/login.py": [10, 11, 12, 15, 20, 25], "models/user.py": [5, 6, 7, 8]}, "ratio": 1.0, "subsetName": "test_user_login_basic", "supersetName": "test_user_login_with_password"}, {"subset": {"auth/login.py": [10, 11, 12, 15, 20, 25], "models/user.py": [5, 6, 7, 8]}, "superset": {"auth/login.py": [10, 11, 12, 15, 20, 25, 45], "models/user.py": [5, 6, 7, 8], "models/admin.py": [50, 51]}, "ratio": 0.7692307692307693, "subsetName": "test_user_login_basic", "supersetName": "test_admin_login"}, {"subset": {"auth/login.py": [10, 11, 12, 15, 20, 25], "models/user.py": [5, 6, 7, 8]}, "superset": {"auth/login.py": [10, 11, 12, 15, 20, 25, 45], "models/user.py": [5, 6, 7, 8], "models/admin.py": [50, 51]}, "ratio": 0.7692307692307693, "subsetName": "test_user_login_with_password", "supersetName": "test_admin_login"}, {"subset": {"auth/logout.py": [1, 2, 3, 4, 5], "models/session.py": [20, 21]}, "superset": {"auth/logout.py": [1, 2, 3, 4, 5, 6, 7], "models/session.py": [20, 21], "models/admin.py": [52]}, "ratio": 0.7, "subsetName": "test_logout_user", "supersetName": "test_logout_admin"}, {"subset": {"auth/login.py": [10, 11, 12, 15, 20, 25], "models/user.py": [5, 6, 7, 8]}, "superset": {"auth/login.py": [10, 11, 12, 15, 20, 25, 45], "models/user.py": [5, 6, 7, 8], "models/admin.py": [50, 51]}, "ratio": 0.7692307692307693, "subsetName": "test_user_login_basic", "supersetName": "test_admin_login"}, {"subset": {"auth/login.py": [10, 11, 12, 15, 20, 25], "models/user.py": [5, 6, 7, 8]}, "superset": {"auth/login.py": [10, 11, 12, 15, 20, 25, 45], "models/user.py": [5, 6, 7, 8], "models/admin.py": [50, 51]}, "ratio": 0.7692307692307693, "subsetName": "test_user_login_with_password", "supersetName": "test_admin_login"}, {"subset": {"auth/logout.py": [1, 2, 3, 4, 5], "models/session.py": [20, 21]}, "superset": {"auth/logout.py": [1, 2, 3, 4, 5, 6, 7], "models/session.py": [20, 21], "models/admin.py": [52]}, "ratio": 0.7, "subsetName": "test_logout_user", "supersetName": "test_logout_admin"}, {"subset": {"views/profile.py": [10, 11, 12, 13, 14], "models/user.py": [5, 6, 7]}, "superset": {"views/profile.py": [10, 11, 12, 13, 14, 20, 21, 22], "models/user.py": [5, 6, 7, 8, 9]}, "ratio": 0.6153846153846154, "subsetName": "test_user_profile_view", "supersetName": "test_user_profile_edit"}, {"subset": {"auth/login.py": [10, 11, 12, 15, 20, 25], "models/user.py": [5, 6, 7, 8]}, "superset": {"auth/login.py": [10, 11, 12, 15, 20, 25, 30, 35, 40], "database/connection.py": [100, 101, 102], "models/user.py": [5, 6, 7, 8, 9, 10]}, "ratio": 0.5555555555555556, "subsetName": "test_user_login_basic", "supersetName": "test_user_login_complete"}, {"subset": {"auth/login.py": [10, 11, 12, 15, 20, 25], "models/user.py": [5, 6, 7, 8]}, "superset": {"auth/login.py": [10, 11, 12, 15, 20, 25, 30, 35, 40], "database/connection.py": [100, 101, 102], "models/user.py": [5, 6, 7, 8, 9, 10]}, "ratio": 0.5555555555555556, "subsetName": "test_user_login_with_password", "supersetName": "test_user_login_complete"}, {"subset": {"auth/login.py": [10, 11, 12]}, "superset": {"auth/login.py": [10, 11, 12, 15, 20, 25], "models/user.py": [5, 6, 7, 8]}, "ratio": 0.3, "subsetName": "test_user_login_minimal", "supersetName": "test_user_login_basic"}, {"subset": {"auth/login.py": [10, 11, 12]}, "superset": {"auth/login.py": [10, 11, 12, 15, 20, 25], "models/user.py": [5, 6, 7, 8]}, "ratio": 0.3, "subsetName": "test_user_login_minimal", "supersetName": "test_user_login_with_password"}, {"subset": {"auth/login.py": [10, 11, 12]}, "superset": {"auth/login.py": [10, 11, 12, 15, 20, 25, 45], "models/user.py": [5, 6, 7, 8], "models/admin.py": [50, 51]}, "ratio": 0.23076923076923078, "subsetName": "test_user_login_minimal", "supersetName": "test_admin_login"}, {"subset": {"auth/login.py": [10, 11, 12]}, "superset": {"auth/login.py": [10, 11, 12, 15, 20, 25, 30, 35, 40], "database/connection.py": [100, 101, 102], "models/user.py": [5, 6, 7, 8, 9, 10]}, "ratio": 0.16666666666666666, "subsetName": "test_user_login_minimal", "supersetName": "test_user_login_complete"}];
        const sourceCode = {};
        let currentData = null;
        let syncEnabled = true;
        let isScrolling = false;
        
        function formatTestName(testName) {
            // Split test name at :: for better readability
            const parts = testName.split('::');
            if (parts.length === 1) return testName;
            
            return parts.map((part, idx) => {
                if (idx === parts.length - 1) {
                    return '<span class="test-part">' + part + '</span>';
                }
                return '<span class="test-part">' + part + '</span><span class="test-separator">::</span><wbr>';
            }).join('');
        }
        
        function showComparison(index) {
            const data = coverageData[index];
            if (!data) return;
            
            currentData = data;
            
            document.getElementById('subsetName').innerHTML = formatTestName(data.subsetName);
            document.getElementById('supersetName').innerHTML = formatTestName(data.supersetName);
            document.getElementById('coverageRatio').textContent = (data.ratio * 100).toFixed(1) + '%';
            
            // Populate file filter
            const allFiles = new Set([...Object.keys(data.subset), ...Object.keys(data.superset)]);
            const fileFilter = document.getElementById('fileFilter');
            fileFilter.innerHTML = '<option value="">All Files</option>';
            Array.from(allFiles).sort().forEach(file => {
                const option = document.createElement('option');
                option.value = file;
                option.textContent = file;
                fileFilter.appendChild(option);
            });
            
            renderBothPanels();
            
            document.getElementById('comparisonModal').style.display = 'block';
            
            // Scroll to top of the modal
            const splitView = document.querySelector('.split-view');
            if (splitView) {
                splitView.scrollTop = 0;
            }
        }
        
        function renderBothPanels() {
            const selectedFile = document.getElementById('fileFilter').value;
            
            // Get all unique files from both sides
            const subsetFiles = Object.keys(currentData.subset).sort();
            const supersetFiles = Object.keys(currentData.superset).sort();
            const allFiles = [...new Set([...subsetFiles, ...supersetFiles])].sort();
            
            // Apply file filter
            const filesToRender = selectedFile ? [selectedFile] : allFiles;
            
            let subsetHtml = '';
            let supersetHtml = '';
            
            for (const file of filesToRender) {
                const subsetLines = currentData.subset[file] || [];
                const supersetLines = currentData.superset[file] || [];
                
                // Get all unique line numbers from both sides
                let allLineNums = [...new Set([...subsetLines, ...supersetLines])].sort((a, b) => a - b);
                
                if (allLineNums.length === 0) continue;
                
                const subsetLineSet = new Set(subsetLines);
                const supersetLineSet = new Set(supersetLines);
                const fileSource = sourceCode[file] || {};
                
                // Find and include method/class definitions for context
                const minLine = Math.min(...allLineNums);
                const maxLine = Math.max(...allLineNums);
                const contextLines = new Set(allLineNums);
                
                // Scan backwards from each covered line to find def/class
                for (const lineNum of allLineNums) {
                    for (let i = lineNum - 1; i >= Math.max(1, minLine - 20); i--) {
                        const line = fileSource[i] || '';
                        const trimmed = line.trim();
                        if (trimmed.startsWith('def ') || trimmed.startsWith('class ') || trimmed.startsWith('async def ')) {
                            contextLines.add(i);
                            break;
                        }
                        // Stop if we hit another definition or empty line followed by def
                        if (trimmed === '' && i < lineNum - 5) break;
                    }
                }
                
                // Convert back to sorted array
                allLineNums = Array.from(contextLines).sort((a, b) => a - b);
                
                // Add file headers
                subsetHtml += '<div class="file-section" style="margin-bottom: 30px;">';
                subsetHtml += '<div class="file-path">üìÑ ' + escapeHtml(file) + '</div>';
                
                supersetHtml += '<div class="file-section" style="margin-bottom: 30px;">';
                supersetHtml += '<div class="file-path">üìÑ ' + escapeHtml(file) + '</div>';
                
                // Render each line with gap detection
                let prevLineNum = null;
                for (let idx = 0; idx < allLineNums.length; idx++) {
                    const lineNum = allLineNums[idx];
                    const sourceLine = fileSource[lineNum] || '';
                    const trimmed = sourceLine.trim();
                    
                    // Skip docstrings
                    if (trimmed.startsWith('"""') || trimmed.startsWith("'''")) {
                        continue;
                    }
                    
                    // Handle gap between lines
                    if (prevLineNum !== null && lineNum - prevLineNum > 1) {
                        const gap = lineNum - prevLineNum - 1;
                        const gapStart = prevLineNum + 1;
                        const gapEnd = lineNum - 1;
                        
                        if (gap > 3) {
                            // Show collapsible gap for >3 lines
                            const gapId = 'gap_' + file.replace(/[^a-zA-Z0-9]/g, '_') + '_' + gapStart + '_' + gapEnd;
                            const gapText = '‚ãÆ (' + gap + ' line' + (gap > 1 ? 's' : '') + ') ‚ãÆ Click to expand';
                            
                            subsetHtml += '<div class="code-line gap-line" style="color: #667eea; text-align: center; font-style: italic; background: #f0f0f0; cursor: pointer; padding: 8px;" ';
                            subsetHtml += 'data-gap-id="' + gapId + '" data-gap-start="' + gapStart + '" data-gap-end="' + gapEnd + '" data-file="' + escapeHtml(file) + '" ';
                            subsetHtml += 'onclick="toggleGap(this, \'subset\')" title="Click to view hidden lines">';
                            subsetHtml += '<strong>' + gapText + '</strong>';
                            subsetHtml += '</div>';
                            
                            supersetHtml += '<div class="code-line gap-line" style="color: #667eea; text-align: center; font-style: italic; background: #f0f0f0; cursor: pointer; padding: 8px;" ';
                            supersetHtml += 'data-gap-id="' + gapId + '" data-gap-start="' + gapStart + '" data-gap-end="' + gapEnd + '" data-file="' + escapeHtml(file) + '" ';
                            supersetHtml += 'onclick="toggleGap(this, \'superset\')" title="Click to view hidden lines">';
                            supersetHtml += '<strong>' + gapText + '</strong>';
                            supersetHtml += '</div>';
                        } else {
                            // Show lines if gap is 3 or less
                            for (let gapLine = gapStart; gapLine <= gapEnd; gapLine++) {
                                const gapSource = fileSource[gapLine] || '';
                                const gapLineNumStr = String(gapLine).padStart(4, ' ');
                                
                                subsetHtml += '<div class="code-line" style="opacity: 0.4; background: #fafafa;">';
                                subsetHtml += '<span style="color: #bbb; margin-right: 10px;">' + gapLineNumStr + '</span>';
                                subsetHtml += '<span style="color: #aaa;">' + escapeHtml(gapSource) + '</span>';
                                subsetHtml += '</div>';
                                
                                supersetHtml += '<div class="code-line" style="opacity: 0.4; background: #fafafa;">';
                                supersetHtml += '<span style="color: #bbb; margin-right: 10px;">' + gapLineNumStr + '</span>';
                                supersetHtml += '<span style="color: #aaa;">' + escapeHtml(gapSource) + '</span>';
                                supersetHtml += '</div>';
                            }
                        }
                    }
                    
                    prevLineNum = lineNum;
                    const lineNumStr = String(lineNum).padStart(4, ' ');
                    const isDefLine = trimmed.startsWith('def ') || trimmed.startsWith('class ') || trimmed.startsWith('async def ');
                    
                    // Render left side (subset)
                    if (subsetLineSet.has(lineNum)) {
                        subsetHtml += '<div class="code-line covered">';
                        subsetHtml += '<span style="color: #999; margin-right: 10px;">' + lineNumStr + '</span>';
                        subsetHtml += escapeHtml(sourceLine) || '‚ñå Covered line';
                        subsetHtml += '</div>';
                    } else if (isDefLine) {
                        // Show def/class lines as context
                        subsetHtml += '<div class="code-line" style="background: #e8f4f8; font-weight: 600;">';
                        subsetHtml += '<span style="color: #999; margin-right: 10px;">' + lineNumStr + '</span>';
                        subsetHtml += escapeHtml(sourceLine);
                        subsetHtml += '</div>';
                    } else {
                        // Show blank line to maintain alignment
                        subsetHtml += '<div class="code-line" style="opacity: 0.3;">';
                        subsetHtml += '<span style="color: #999; margin-right: 10px;">' + lineNumStr + '</span>';
                        subsetHtml += '<span style="color: #ccc;">‚Äî</span>';
                        subsetHtml += '</div>';
                    }
                    
                    // Render right side (superset)
                    if (supersetLineSet.has(lineNum)) {
                        supersetHtml += '<div class="code-line covered">';
                        supersetHtml += '<span style="color: #999; margin-right: 10px;">' + lineNumStr + '</span>';
                        supersetHtml += escapeHtml(sourceLine) || '‚ñå Covered line';
                        supersetHtml += '</div>';
                    } else if (isDefLine) {
                        // Show def/class lines as context
                        supersetHtml += '<div class="code-line" style="background: #e8f4f8; font-weight: 600;">';
                        supersetHtml += '<span style="color: #999; margin-right: 10px;">' + lineNumStr + '</span>';
                        supersetHtml += escapeHtml(sourceLine);
                        supersetHtml += '</div>';
                    } else {
                        // Show blank line to maintain alignment
                        supersetHtml += '<div class="code-line" style="opacity: 0.3;">';
                        supersetHtml += '<span style="color: #999; margin-right: 10px;">' + lineNumStr + '</span>';
                        supersetHtml += '<span style="color: #ccc;">‚Äî</span>';
                        supersetHtml += '</div>';
                    }
                }
                
                subsetHtml += '</div>';
                supersetHtml += '</div>';
            }
            
            document.getElementById('subsetContent').innerHTML = subsetHtml || '<p style="padding: 20px; color: #7f8c8d;">No coverage data</p>';
            document.getElementById('supersetContent').innerHTML = supersetHtml || '<p style="padding: 20px; color: #7f8c8d;">No coverage data</p>';
        }
        
        function applyFileFilter() {
            renderBothPanels();
        }
        
        function toggleSync() {
            syncEnabled = !syncEnabled;
            const checkbox = document.getElementById('syncCheckbox');
            const toggle = document.getElementById('syncToggle');
            const splitView = document.querySelector('.split-view');
            const filePanels = document.querySelectorAll('.file-panel');
            
            checkbox.checked = syncEnabled;
            if (syncEnabled) {
                toggle.classList.add('active');
                // Use single scroll - both panels scroll together
                splitView.classList.remove('independent');
                filePanels.forEach(panel => panel.classList.remove('independent'));
            } else {
                toggle.classList.remove('active');
                // Enable independent scrolling for each panel
                splitView.classList.add('independent');
                filePanels.forEach(panel => panel.classList.add('independent'));
            }
        }
        
        function toggleGap(element, side) {
            const gapId = element.getAttribute('data-gap-id');
            const gapStart = parseInt(element.getAttribute('data-gap-start'));
            const gapEnd = parseInt(element.getAttribute('data-gap-end'));
            const file = element.getAttribute('data-file');
            
            // Find the corresponding gap in the other panel
            const otherSide = side === 'subset' ? 'superset' : 'subset';
            const otherContent = document.getElementById(otherSide + 'Content');
            const otherGap = otherContent.querySelector('.gap-line[data-gap-id="' + gapId + '"]');
            
            // Check if already expanded
            const isExpanded = element.classList.contains('expanded');
            
            if (isExpanded) {
                // Collapse both sides
                const expandedLines = element.parentElement.querySelectorAll('.expanded-line[data-gap-id="' + gapId + '"]');
                expandedLines.forEach(line => line.remove());
                element.classList.remove('expanded');
                element.innerHTML = '<strong>‚ãÆ (' + (gapEnd - gapStart + 1) + ' line' + (gapEnd - gapStart > 0 ? 's' : '') + ') ‚ãÆ Click to expand</strong>';
                
                // Collapse other side
                if (otherGap) {
                    const otherExpandedLines = otherGap.parentElement.querySelectorAll('.expanded-line[data-gap-id="' + gapId + '"]');
                    otherExpandedLines.forEach(line => line.remove());
                    otherGap.classList.remove('expanded');
                    otherGap.innerHTML = '<strong>‚ãÆ (' + (gapEnd - gapStart + 1) + ' line' + (gapEnd - gapStart > 0 ? 's' : '') + ') ‚ãÆ Click to expand</strong>';
                }
            } else {
                // Expand both sides
                const fileSource = sourceCode[file] || {};
                element.classList.add('expanded');
                element.innerHTML = '<strong>‚ãÆ Click to collapse ‚ãÆ</strong>';
                
                let insertHtml = '';
                for (let lineNum = gapStart; lineNum <= gapEnd; lineNum++) {
                    const sourceLine = fileSource[lineNum] || '';
                    const lineNumStr = String(lineNum).padStart(4, ' ');
                    
                    insertHtml += '<div class="code-line expanded-line" data-gap-id="' + gapId + '" style="opacity: 0.6; background: #f9f9f9; border-left: 3px solid #667eea;">';
                    insertHtml += '<span style="color: #aaa; margin-right: 10px;">' + lineNumStr + '</span>';
                    insertHtml += '<span style="color: #666;">' + escapeHtml(sourceLine) + '</span>';
                    insertHtml += '</div>';
                }
                
                // Insert after the gap element on current side
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = insertHtml;
                while (tempDiv.firstChild) {
                    element.parentNode.insertBefore(tempDiv.firstChild, element.nextSibling);
                }
                
                // Expand other side
                if (otherGap) {
                    otherGap.classList.add('expanded');
                    otherGap.innerHTML = '<strong>‚ãÆ Click to collapse ‚ãÆ</strong>';
                    
                    const tempDiv2 = document.createElement('div');
                    tempDiv2.innerHTML = insertHtml;
                    while (tempDiv2.firstChild) {
                        otherGap.parentNode.insertBefore(tempDiv2.firstChild, otherGap.nextSibling);
                    }
                }
            }
        }
        
        function closeModal() {
            document.getElementById('comparisonModal').style.display = 'none';
            currentData = null;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        window.onclick = function(event) {
            const modal = document.getElementById('comparisonModal');
            if (event.target == modal) {
                closeModal();
            }
        }
        
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeModal();
            }
        });
        
        // Format all test names on page load
        document.addEventListener('DOMContentLoaded', function() {
            const testNames = document.querySelectorAll('.test-name');
            testNames.forEach(el => {
                const originalText = el.textContent;
                if (originalText.includes('::')) {
                    el.innerHTML = formatTestName(originalText);
                }
            });
        });
        </script>
        
        <div class="footer">
            <p>Generated by <strong>TestIQ</strong> - Intelligent Test Analysis</p>
            <p>üîó <a href="https://github.com/pydevtools/TestIQ" style="color: #667eea;">github.com/pydevtools/TestIQ</a></p>
        </div>
    </div>
</body>
</html>
